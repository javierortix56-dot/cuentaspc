<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&M Command Center Pro</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='128' fill='%2310B981'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='central' text-anchor='middle' font-family='sans-serif' font-weight='800' font-size='320' fill='white'%3E$%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #F1F5F9;
            --bg-panel: #FFFFFF;
            --border: #E2E8F0;
            --text-main: #0F172A;
            --text-muted: #64748B;
            --primary: #2563EB; --primary-light: #EFF6FF;
            --success: #10B981; --success-light: #ECFDF5;
            --danger: #EF4444; --danger-light: #FEF2F2;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-body); 
            color: var(--text-main); margin: 0; height: 100vh; overflow: hidden;
            display: flex;
        }

        /* --- SIDEBAR (IZQUIERDA) --- */
        .sidebar {
            width: 260px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 25px; z-index: 10;
        }
        .brand { font-size: 20px; font-weight: 900; color: var(--text-main); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .brand i { color: var(--success); }

        /* --- KPI BOX CORREGIDO PARA NÚMEROS LARGOS --- */
        .kpi-box {
            background: var(--bg-body); border-radius: 12px; padding: 20px; border: 1px solid var(--border);
            margin-bottom: 20px; text-align: center;
            /* Container Query: Permite que el hijo sepa el ancho del padre */
            container-type: inline-size; 
        }
        .kpi-title { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .kpi-value { 
            /* Fuente dinámica: Min 18px, Ideal 13% del contenedor, Max 28px */
            font-size: clamp(18px, 13cqw, 28px); 
            font-weight: 800; 
            color: var(--text-main); 
            margin: 5px 0; 
            overflow-wrap: break-word; /* Evita desborde si es gigantesco */
            line-height: 1.1;
        }
        
        .kpi-sub { font-size: 13px; font-weight: 600; color: var(--text-muted); display: flex; justify-content: center; gap: 5px; }
        
        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .nav-item {
            padding: 12px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-muted);
            display: flex; align-items: center; gap: 10px; transition: 0.2s; border: none; background: none; width: 100%; text-align: left;
        }
        .nav-item:hover { background: var(--bg-body); color: var(--primary); }
        .nav-item.danger:hover { background: var(--danger-light); color: var(--danger); }

        .footer-tools { border-top: 1px solid var(--border); padding-top: 20px; }
        .input-rate { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-weight: 700; color: var(--text-muted); text-align: right; }

        /* --- MAIN AREA (CENTRO) --- */
        .main-stage {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
        }

        .top-header {
            height: 70px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
        }
        
        .date-navigator {
            display: flex; align-items: center; background: var(--bg-body); border-radius: 8px; padding: 4px; border: 1px solid var(--border);
        }
        .btn-nav { border: none; background: transparent; cursor: pointer; padding: 5px 10px; color: var(--text-muted); font-size: 14px; }
        .btn-nav:hover { color: var(--primary); }
        .current-month { font-weight: 800; font-size: 14px; text-transform: uppercase; min-width: 140px; text-align: center; position: relative; }
        
        .search-bar {
            position: relative; width: 300px;
        }
        .search-bar input {
            width: 100%; padding: 10px 15px 10px 35px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-body); font-family: 'Inter'; font-size: 13px;
        }
        .search-bar i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; }

        .content-grid {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 0; overflow: hidden; position: relative;
        }
        
        .col-panel {
            display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow: hidden;
        }
        .col-panel:last-child { border-right: none; }
        
        .panel-header {
            padding: 15px 20px; font-weight: 800; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid var(--border);
        }
        .ph-inc { color: var(--success); border-top: 4px solid var(--success); }
        .ph-exp { color: var(--danger); border-top: 4px solid var(--danger); }
        .total-badge { background: var(--bg-body); padding: 4px 8px; border-radius: 4px; color: var(--text-main); font-size: 14px; }

        .tx-list {
            flex: 1; overflow-y: auto; padding: 0; background: #fff;
        }
        .tx-row {
            display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid var(--bg-body); cursor: pointer; transition: 0.1s;
        }
        .tx-row:hover { background: #F8FAFC; border-left: 3px solid var(--primary); padding-left: 17px; }
        .tx-date { font-size: 12px; font-weight: 700; color: var(--text-muted); width: 35px; }
        .tx-desc { flex: 1; font-weight: 600; font-size: 13px; color: var(--text-main); }
        .tx-cat { font-size: 10px; font-weight: 700; color: var(--text-muted); background: var(--bg-body); padding: 2px 6px; border-radius: 4px; margin-left: 8px; text-transform: uppercase; }
        .tx-amt { font-weight: 700; font-size: 14px; text-align: right; }
        .amt-inc { color: var(--success); } .amt-exp { color: var(--danger); }
        
        /* --- ESTADO VACIO / COPY MODE --- */
        .empty-state {
            position: absolute; inset: 0; background: white; z-index: 5;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .empty-card {
            background: var(--bg-body); padding: 40px; border-radius: 20px; text-align: center; border: 2px dashed var(--border);
            max-width: 400px; width: 100%;
        }
        .copy-controls { display: flex; gap: 10px; margin-top: 20px; }
        .btn-copy-action {
            flex: 1; background: var(--text-main); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 700; cursor: pointer;
        }
        .btn-copy-action:hover { background: #334155; }

        /* --- RIGHT PANEL (TOOLS) --- */
        .tools-panel {
            width: 320px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 10;
        }

        .chart-container {
            padding: 20px; border-bottom: 1px solid var(--border); height: 280px; position: relative;
        }
        .chart-reset { position: absolute; top: 10px; right: 20px; font-size: 11px; cursor: pointer; color: var(--primary); font-weight: 700; border: none; background: none; }

        .form-container {
            flex: 1; padding: 25px; overflow-y: auto; background: var(--bg-body);
        }
        .form-title { font-weight: 800; font-size: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .switch-type { display: flex; background: #E2E8F0; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
        .switch-opt { flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: 700; cursor: pointer; border-radius: 6px; color: var(--text-muted); transition: 0.2s; }
        .switch-opt.active-exp { background: white; color: var(--danger); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .switch-opt.active-inc { background: white; color: var(--success); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .form-group { margin-bottom: 12px; flex: 1; }
        .form-label { display: block; font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: 'Inter'; font-size: 13px; transition: 0.2s; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }

        .btn-submit { width: 100%; padding: 14px; background: var(--text-main); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .alert-bubble { display: inline-block; width: 8px; height: 8px; background: #F59E0B; border-radius: 50%; margin-left: 5px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1100px) {
            .tools-panel { display: none; } /* En pantallas medianas ocultar panel derecho */
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="brand">
        <i class="fas fa-wallet"></i> COMMAND CENTER
    </div>

    <div class="kpi-box">
        <div class="kpi-title">Balance Neto</div>
        <div class="kpi-value" id="kpiBal">$0</div>
        <div class="kpi-sub">
            <span style="color:#94A3B8">USD</span>
            <span id="kpiUsd">0.00</span>
        </div>
    </div>

    <div class="nav-menu">
        <button class="nav-item" onclick="backup()"><i class="fas fa-download"></i> Backup Datos</button>
        <button class="nav-item" onclick="document.getElementById('fileIn').click()"><i class="fas fa-upload"></i> Restaurar</button>
        <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
        <div style="flex:1"></div>
        <button class="nav-item danger" onclick="clearCurrentMonth()"><i class="fas fa-trash"></i> Limpiar Mes</button>
    </div>

    <div class="footer-tools">
        <div class="form-label">Dolar Blue (ARS)</div>
        <input type="number" id="usdRate" value="1200" class="form-input" style="text-align:right; font-weight:800;" onchange="loadData()">
    </div>
</aside>

<main class="main-stage">
    <header class="top-header">
        <div class="date-navigator">
            <button class="btn-nav" onclick="navMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="current-month">
                <span id="monthTxt">...</span>
                <input type="month" id="dateInput" onchange="loadData()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
            </div>
            <button class="btn-nav" onclick="navMonth(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar movimiento..." onkeyup="filterData()">
        </div>
    </header>

    <div class="content-grid">
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-card">
                <i class="fas fa-folder-open" style="font-size:40px; color:var(--text-muted); margin-bottom:20px;"></i>
                <h3 style="margin:0; font-size:18px;">Mes sin movimientos</h3>
                <p style="color:var(--text-muted); font-size:13px;">Este mes está limpio. ¿Quieres copiar la estructura del mes anterior?</p>
                
                <div class="copy-controls">
                    <input type="month" id="copySourcePicker" class="form-input" style="width:140px;">
                    <button class="btn-copy-action" onclick="copyFromSelected()">Importar</button>
                </div>
            </div>
        </div>

        <div class="col-panel">
            <div class="panel-header ph-inc">
                <span>Ingresos</span>
                <span class="total-badge" id="sum-inc">$0</span>
            </div>
            <div class="tx-list" id="list-inc"></div>
        </div>

        <div class="col-panel">
            <div class="panel-header ph-exp">
                <span>Egresos</span>
                <span class="total-badge" id="sum-exp">$0</span>
            </div>
            <div class="tx-list" id="list-exp"></div>
        </div>
    </div>
</main>

<aside class="tools-panel">
    <div class="chart-container">
        <button id="chartReset" class="chart-reset" onclick="resetChart()">Ver Todo</button>
        <canvas id="myChart"></canvas>
    </div>

    <div class="form-container">
        <div class="form-title">
            <span id="formTitle">Nuevo</span>
            <button onclick="resetForm()" style="border:none; background:none; cursor:pointer; font-size:12px; color:var(--text-muted);">Limpiar</button>
        </div>

        <form id="txForm">
            <div class="switch-type">
                <div class="switch-opt active-exp" id="sw-exp" onclick="setType('exp')">Gastos</div>
                <div class="switch-opt" id="sw-inc" onclick="setType('inc')">Ingresos</div>
            </div>
            <input type="hidden" id="fType" value="exp">

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="fDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" id="fAmount" class="form-input" step="0.01" placeholder="0.00" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Categoría</label>
                <select id="fCat" class="form-input" onchange="renderConcepts()" required></select>
            </div>

            <div class="form-group">
                <label class="form-label">Concepto</label>
                <select id="fConcept" class="form-input" onchange="checkNewConcept()" required></select>
                <input type="text" id="fConceptCustom" class="form-input" style="margin-top:5px; display:none;" placeholder="Nombre personalizado...">
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin: 15px 0;">
                <input type="checkbox" id="fExec" checked style="cursor:pointer;">
                <label for="fExec" style="font-size:12px; font-weight:600; cursor:pointer;">Consolidado (Pagado/Cobrado)</label>
            </div>

            <button type="submit" id="btnSave" class="btn-submit">GUARDAR MOVIMIENTO</button>
            <button type="button" id="btnDel" onclick="del(editId)" style="width:100%; background:white; color:var(--danger); border:1px solid var(--border); padding:10px; border-radius:8px; margin-top:10px; cursor:pointer; font-weight:700; display:none;">Eliminar</button>
        </form>
    </div>
</aside>

<script>
    // --- LÓGICA COMPARTIDA V33 (COMPATIBILIDAD TOTAL) ---
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: { "Esenciales": ["Alquiler", "Luz/Gas", "Supermercado"], "Deudas": ["Tarjeta Visa"], "Sueldo": ["Javier", "Mary"] } };
    let data = JSON.parse(localStorage.getItem('finData_v16')) || defData;
    let editId = null, chartInstance = null, currentTxs = [];

    window.onload = () => {
        const d = new Date();
        const currentYM = d.toISOString().slice(0, 7);
        document.getElementById('dateInput').value = currentYM;
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        
        // Setup Copy Picker defaults
        const prevM = new Date(d.getFullYear(), d.getMonth() - 1, 1);
        document.getElementById('copySourcePicker').value = prevM.toISOString().slice(0, 7);

        if(localStorage.getItem('usdRate')) document.getElementById('usdRate').value = localStorage.getItem('usdRate');
        loadData();
    };

    function navMonth(n) { 
        const i = document.getElementById('dateInput'); 
        let [y, m] = i.value.split('-'); 
        const current = new Date(parseInt(y), parseInt(m)-1, 1);
        current.setMonth(current.getMonth() + n);
        const newY = current.getFullYear();
        const newM = String(current.getMonth() + 1).padStart(2, '0');
        i.value = `${newY}-${newM}`;
        loadData(); 
    }

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
        document.getElementById('monthTxt').innerText = `${months[parseInt(m)-1]} ${y}`;
        
        // Reset Search
        document.getElementById('searchInput').value = '';

        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => a.date.localeCompare(b.date));
        
        // Manejo de Estado Vacío (Copy Logic)
        const emptyState = document.getElementById('emptyState');
        if(currentTxs.length === 0) {
            emptyState.style.display = 'flex';
            const visibleDate = new Date(parseInt(y), parseInt(m)-1, 1);
            const prev = new Date(visibleDate.getFullYear(), visibleDate.getMonth()-1, 1);
            document.getElementById('copySourcePicker').value = prev.toISOString().slice(0,7);
        } else {
            emptyState.style.display = 'none';
        }
        
        renderLists(currentTxs);
        resetChart();
        renderCats();
        localStorage.setItem('usdRate', document.getElementById('usdRate').value);
    }

    // --- BUSCADOR (Feature Exclusivo PC) ---
    function filterData() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        if(!term) { renderLists(currentTxs); return; }
        
        const filtered = currentTxs.filter(t => 
            t.desc.toLowerCase().includes(term) || 
            t.cat.toLowerCase().includes(term) ||
            t.amount.toString().includes(term)
        );
        renderLists(filtered);
    }

    // --- COPIAR MES (Lógica V33) ---
    function copyFromSelected() {
        const targetYM = document.getElementById('dateInput').value; 
        const sourceYM = document.getElementById('copySourcePicker').value; 
        
        if(!sourceYM) { alert('Selecciona origen'); return; }
        if(sourceYM === targetYM) { alert('Mismo mes seleccionado'); return; }

        const sourceTxs = data.txs.filter(t => t.date.startsWith(sourceYM));
        if(sourceTxs.length === 0) { alert('El mes origen está vacío.'); return; }
        
        if(!confirm(`¿Importar ${sourceTxs.length} movimientos de ${sourceYM}?`)) return;

        const [tY, tM] = targetYM.split('-').map(Number); 

        sourceTxs.forEach(t => {
            const oldDay = parseInt(t.date.split('-')[2]);
            let newDateObj = new Date(tY, tM - 1, oldDay);
            if (newDateObj.getMonth() !== tM - 1) newDateObj = new Date(tY, tM, 0); 
            
            data.txs.push({
                ...t, id: Date.now() + Math.random(),
                date: newDateObj.toISOString().split('T')[0],
                exec: false 
            });
        });
        save(); loadData();
    }

    function clearCurrentMonth() {
        const ym = document.getElementById('dateInput').value;
        if(!confirm(`¿Borrar TODO en ${ym}? Esta acción no se puede deshacer.`)) return;
        data.txs = data.txs.filter(t => !t.date.startsWith(ym));
        save(); loadData();
    }

    // --- RENDERIZADO ---
    function renderLists(txs) {
        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';
        let tInc=0, tExp=0; const today = new Date().toISOString().split('T')[0];

        txs.forEach(t => {
            const isInc = t.type === 'inc';
            const amt = Math.abs(t.amount);
            if(isInc) tInc += amt; else tExp += amt;

            let alertHTML = '';
            if(!t.exec && !isInc) {
                const diff = (new Date(t.date) - new Date(today)) / (86400000);
                if(diff <= 5) alertHTML = `<span class="alert-bubble" title="Vence pronto"></span>`;
            }

            const div = document.createElement('div');
            div.className = 'tx-row';
            div.style.opacity = !t.exec ? '0.6' : '1';
            div.onclick = () => edit(t.id);
            div.innerHTML = `
                <div class="tx-date">${t.date.split('-')[2]}</div>
                <div class="tx-desc">${t.desc} ${alertHTML}</div>
                <div class="tx-cat">${t.cat}</div>
                <div class="tx-amt ${isInc?'amt-inc':'amt-exp'}">$${Math.floor(amt).toLocaleString()}</div>
            `;
            (isInc ? lInc : lExp).appendChild(div);
        });

        document.getElementById('sum-inc').innerText = `$${tInc.toLocaleString()}`;
        document.getElementById('sum-exp').innerText = `$${tExp.toLocaleString()}`;
        
        const bal = tInc - tExp;
        const balEl = document.getElementById('kpiBal');
        balEl.innerText = `$${bal.toLocaleString()}`;
        balEl.style.color = bal >= 0 ? 'var(--success)' : 'var(--danger)';

        const rate = parseFloat(document.getElementById('usdRate').value) || 1;
        document.getElementById('kpiUsd').innerText = (bal/rate).toFixed(2);
    }

    // --- CHART ---
    function resetChart() { renderChart(currentTxs, null); }
    function renderChart(txs, filterCat) {
        const ctx = document.getElementById('myChart'); 
        if(chartInstance) chartInstance.destroy();
        
        const btnReset = document.getElementById('chartReset');
        let exps = txs.filter(t => t.type === 'exp');
        let map = {};

        if (!filterCat) {
            btnReset.style.display = 'none';
            map = exps.reduce((a,t)=>{ a[t.cat]=(a[t.cat]||0)+t.amount; return a; }, {});
        } else {
            btnReset.style.display = 'block';
            map = exps.filter(t => t.cat === filterCat).reduce((a,t)=>{ a[t.desc]=(a[t.desc]||0)+t.amount; return a; }, {});
        }

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: Object.keys(map), 
                datasets: [{ 
                    data: Object.values(map), 
                    backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1'],
                    borderWidth: 2, borderColor: '#ffffff'
                }] 
            },
            options: { 
                responsive:true, maintainAspectRatio:false, cutout:'65%',
                plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, font: {size:10} } } },
                onClick: (e, elements) => {
                    if (elements.length > 0 && !filterCat) {
                        renderChart(txs, Object.keys(map)[elements[0].index]);
                    }
                }
            }
        });
    }

    // --- FORMULARIO & EDICIÓN ---
    function setType(t) {
        document.getElementById('fType').value = t;
        document.getElementById('sw-inc').className = `switch-opt ${t=='inc'?'active-inc':''}`;
        document.getElementById('sw-exp').className = `switch-opt ${t=='exp'?'active-exp':''}`;
        renderCats();
    }
    
    function renderCats() {
        const t = document.getElementById('fType').value;
        const s = document.getElementById('fCat'); s.innerHTML='';
        (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear...','new'));
        renderConcepts();
    }
    
    function renderConcepts() {
        const cVal = document.getElementById('fCat').value;
        if(cVal==='new'){ 
            const n=prompt('Nueva Categoría:'); 
            if(n){ data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; save(); renderCats(); document.getElementById('fCat').value=n; } 
            else { renderCats(); return; }
        }
        const s = document.getElementById('fConcept'); s.innerHTML='';
        (data.concepts[cVal]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Nuevo...','new_c'));
        checkNewConcept();
    }
    
    function checkNewConcept() {
        const isNew = document.getElementById('fConcept').value==='new_c';
        document.getElementById('fConceptCustom').style.display=isNew?'block':'none';
    }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value;
        let desc = document.getElementById('fConcept').value;
        if(desc==='new_c') {
            desc=document.getElementById('fConceptCustom').value;
            if(!desc) return;
            if(!data.concepts[cat]) data.concepts[cat]=[];
            data.concepts[cat].push(desc);
        }
        const tx = { id:editId||Date.now(), date:document.getElementById('fDate').value, amount:parseFloat(document.getElementById('fAmount').value), type:document.getElementById('fType').value, cat, desc, exec:document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i!==-1) data.txs[i]=tx; } else data.txs.push(tx);
        save(); resetForm(); loadData();
    }

    function edit(id) {
        const t = data.txs.find(x=>x.id==id); if(!t)return;
        editId=id; document.getElementById('formTitle').innerText='Editando...';
        document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=Math.abs(t.amount);
        document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts();
        
        const s=document.getElementById('fConcept');
        let has=false; for(let i=0;i<s.options.length;i++) if(s.options[i].value==t.desc) has=true;
        if(!has) s.add(new Option(t.desc,t.desc),0); s.value=t.desc;
        
        checkNewConcept(); document.getElementById('btnDel').style.display='block'; document.getElementById('btnSave').innerText='ACTUALIZAR';
    }

    function resetForm() { 
        editId=null; document.getElementById('txForm').reset(); 
        document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; 
        document.getElementById('formTitle').innerText='Nuevo'; 
        document.getElementById('btnDel').style.display='none'; 
        document.getElementById('fConceptCustom').style.display='none'; 
        document.getElementById('btnSave').innerText='GUARDAR MOVIMIENTO'; 
        setType('exp'); 
    }
    
    function del(id) { if(confirm('¿Borrar?')) { data.txs=data.txs.filter(x=>x.id!=id); save(); resetForm(); loadData(); } }
    function save() { localStorage.setItem('finData_v16', JSON.stringify(data)); }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`JM_Backup.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ try{data=JSON.parse(e.target.result); save(); location.reload();}catch(x){alert('Archivo incorrecto');} }; r.readAsText(i.files[0]); }
</script>
</body>
</html>
