<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&M Financial Suite V38</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Palette Pro */
            --sidebar-bg: #0F172A;
            --sidebar-text: #94A3B8;
            --sidebar-hover: #1E293B;
            --sidebar-active: #3B82F6;
            
            --main-bg: #F3F4F6;
            --card-bg: #FFFFFF;
            
            --text-main: #111827;
            --text-secondary: #6B7280;
            
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--main-bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: 0.3s;
        }
        
        .logo-box {
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 25px;
            font-size: 20px;
            font-weight: 800;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            letter-spacing: -0.5px;
        }
        .logo-box span { color: var(--info); margin-left: 5px; }

        .nav-menu {
            padding: 20px 15px;
            flex: 1;
        }
        
        .nav-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #64748B;
            font-weight: 700;
            margin-bottom: 10px;
            padding-left: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--sidebar-text);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        .nav-item:hover { background: var(--sidebar-hover); color: white; }
        .nav-item.active { background: var(--sidebar-active); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .nav-item i { width: 20px; text-align: center; }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .connection-status {
            display: flex; align-items: center; gap: 10px;
            font-size: 12px; color: #94A3B8; font-weight: 600;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #475569; transition:0.3s; }
        .dot.online { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* --- MAIN AREA --- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        .top-header {
            height: 70px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
        }
        .page-title h1 { margin: 0; font-size: 18px; font-weight: 700; }
        .page-title p { margin: 0; font-size: 12px; color: var(--text-secondary); }

        .header-actions { display: flex; align-items: center; gap: 15px; }

        .month-selector {
            display: flex; align-items: center; background: #F8FAFC; 
            border: 1px solid var(--border); border-radius: 8px; padding: 5px;
        }
        .btn-nav {
            border: none; background: transparent; width: 30px; height: 30px; 
            border-radius: 6px; cursor: pointer; color: var(--text-secondary);
        }
        .btn-nav:hover { background: #E2E8F0; color: var(--text-main); }
        .current-month-display {
            font-size: 13px; font-weight: 700; text-transform: uppercase;
            padding: 0 15px; min-width: 140px; text-align: center; position: relative;
        }

        .btn-primary {
            background: var(--text-main); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-primary:hover { background: #000; transform: translateY(-1px); }

        /* DASHBOARD CONTENT */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* KPI Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
        }
        .stat-icon {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; opacity: 0.8;
        }
        .stat-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
        .stat-value { font-size: 26px; font-weight: 800; margin-top: 10px; color: var(--text-main); }
        
        /* Layout Split */
        .dashboard-split {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2/3 para tablas, 1/3 para panel */
            gap: 25px;
        }

        /* Tables */
        .table-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex; flex-direction: column;
            margin-bottom: 25px;
        }
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: #F9FAFB;
        }
        .card-title { font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .tag { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        .tag.inc { background: #DCFCE7; color: #166534; }
        .tag.exp { background: #FEE2E2; color: #991B1B; }

        .custom-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .custom-table th { 
            text-align: left; padding: 12px 20px; 
            color: var(--text-secondary); font-weight: 600; font-size: 11px; text-transform: uppercase;
            border-bottom: 1px solid var(--border); background: #fff;
        }
        .custom-table td { 
            padding: 12px 20px; border-bottom: 1px solid var(--border); color: var(--text-main); 
        }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover td { background: #F8FAFC; cursor: pointer; }
        
        .amt-cell { font-weight: 700; font-family: 'Inter', sans-serif; }
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .cat-badge { 
            display: inline-block; padding: 3px 8px; border-radius: 12px; 
            background: #F3F4F6; color: var(--text-secondary); font-size: 11px; font-weight: 600; 
        }

        /* Analytics Panel (Right Side) */
        .analytics-col { display: flex; flex-direction: column; gap: 25px; }
        
        .chart-card {
            background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border);
            padding: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 300px;
        }
        
        .usd-card {
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
            border-radius: 12px; padding: 20px; color: white;
            box-shadow: var(--shadow);
        }
        .usd-label { font-size: 11px; color: #94A3B8; font-weight: 700; text-transform: uppercase; }
        .usd-val { font-size: 28px; font-weight: 800; margin: 5px 0 15px 0; }
        .usd-input-group { 
            display: flex; align-items: center; justify-content: space-between; 
            background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;
        }
        .usd-inp { 
            background: transparent; border: none; color: white; font-weight: 700; 
            text-align: right; width: 60px; outline: none;
        }

        /* --- MODAL FORM --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(4px); }
        .modal-pro { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            background: white; width: 420px; padding: 0; border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .modal-pro.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .inp-control { margin-bottom: 15px; }
        .inp-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 6px; }
        .inp-field { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #F9FAFB; transition:0.2s; }
        .inp-field:focus { background: white; border-color: var(--info); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        .switch-type { display: flex; background: #F1F5F9; padding: 4px; border-radius: 8px; margin-bottom: 20px; }
        .st-opt { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--text-secondary); transition: 0.2s; }
        .st-opt.active.inc { background: var(--success); color: white; }
        .st-opt.active.exp { background: var(--danger); color: white; }

        .btn-full { width: 100%; padding: 12px; background: var(--text-main); color: white; font-weight: 700; border-radius: 8px; border: none; cursor: pointer; }
        .btn-danger-text { width: 100%; margin-top: 10px; background: none; border: none; color: var(--danger); font-size: 12px; font-weight: 700; cursor: pointer; }
        
        .fab-mobile { display: none; } /* Solo por si acaso */

    </style>
</head>
<body>

<aside class="sidebar">
    <div class="logo-box">
        J&M<span>Cloud</span>
    </div>
    <div class="nav-menu">
        <div class="nav-label">Principal</div>
        <div class="nav-item active">
            <i class="fas fa-home"></i> Dashboard
        </div>
        <div class="nav-label" style="margin-top: 20px;">Datos</div>
        <div class="nav-item" onclick="backup()">
            <i class="fas fa-download"></i> Backup Local
        </div>
        <div class="nav-item" onclick="document.getElementById('fileIn').click()">
            <i class="fas fa-file-upload"></i> Restaurar JSON
            <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
        </div>
        <div class="nav-item" onclick="forceSync()">
            <i class="fas fa-sync-alt"></i> Sincronizar
        </div>
        <div class="nav-item" style="color: #EF4444;" onclick="clearMonth()">
            <i class="fas fa-trash"></i> Limpiar Mes
        </div>
    </div>
    <div class="sidebar-footer">
        <div class="connection-status">
            <div id="statusDot" class="dot"></div>
            <span id="syncStatusText">Conectando...</span>
        </div>
    </div>
</aside>

<div class="main-wrapper">
    
    <header class="top-header">
        <div class="page-title">
            <h1>Panel Financiero</h1>
            <p>Resumen mensual y movimientos</p>
        </div>
        <div class="header-actions">
            <div class="month-selector">
                <button class="btn-nav" onclick="navMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="current-month-display">
                    <span id="monthTxt">...</span>
                    <input type="month" id="dateInput" onchange="loadData()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                </div>
                <button class="btn-nav" onclick="navMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <button class="btn-primary" onclick="openSheet()">
                <i class="fas fa-plus"></i> Nuevo
            </button>
        </div>
    </header>

    <div class="content-scroll">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #DCFCE7; color: #166534;"><i class="fas fa-arrow-down"></i></div>
                <div class="stat-label">Ingresos</div>
                <div class="stat-value positive" id="sum-inc">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #FEE2E2; color: #991B1B;"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-label">Gastos</div>
                <div class="stat-value negative" id="sum-exp">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #DBEAFE; color: #1E40AF;"><i class="fas fa-wallet"></i></div>
                <div class="stat-label">Balance Neto</div>
                <div class="stat-value" id="kpiBal">$0</div>
            </div>
             <div class="stat-card">
                <div class="stat-icon" style="background: #FEF3C7; color: #B45309;"><i class="fas fa-percent"></i></div>
                <div class="stat-label">Tasa Ahorro</div>
                <div class="stat-value" id="savingRate">0%</div>
            </div>
        </div>

        <div class="dashboard-split">
            
            <div class="tables-col">
                
                <div class="table-card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-circle" style="font-size:8px; color:#10B981;"></i> Ingresos Recientes</div>
                        <div class="tag inc">Entradas</div>
                    </div>
                    <table class="custom-table">
                        <thead><tr><th>Fecha</th><th>Categoría</th><th>Concepto</th><th style="text-align:right;">Monto</th></tr></thead>
                        <tbody id="table-inc"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-circle" style="font-size:8px; color:#EF4444;"></i> Gastos Recientes</div>
                        <div class="tag exp">Salidas</div>
                    </div>
                    <table class="custom-table">
                        <thead><tr><th>Fecha</th><th>Categoría</th><th>Concepto</th><th style="text-align:right;">Monto</th></tr></thead>
                        <tbody id="table-exp"></tbody>
                    </table>
                </div>

            </div>

            <div class="analytics-col">
                
                <div class="usd-card">
                    <div class="usd-label">Balance en Dólares</div>
                    <div class="usd-val" id="kpiUsd">0.00</div>
                    <div class="usd-input-group">
                        <span style="font-size:12px; opacity:0.8;">TIPO DE CAMBIO</span>
                        <input type="number" id="usdRate" value="1200" class="usd-inp" onchange="loadData()">
                    </div>
                </div>

                <div class="chart-card">
                    <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:15px;">
                        <span style="font-weight:700; font-size:13px;">Distribución</span>
                        <button id="chartReset" onclick="resetChart()" style="border:none; background:none; color:var(--info); font-size:11px; cursor:pointer; display:none;">Ver Todo</button>
                    </div>
                    <div style="position:relative; height:200px; width:200px;">
                        <canvas id="myChart"></canvas>
                        <div id="chartCenterText" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:10px; color:#64748B; pointer-events:none; font-weight:600; text-align:center;">Detalle</div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="modal-pro" id="modal">
    <div class="modal-header">
        <span style="font-weight:700; font-size:16px;" id="formTitle">Nuevo Movimiento</span>
        <button onclick="closeSheet()" style="background:none; border:none; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
        <form id="txForm">
            <div class="switch-type">
                <div class="st-opt" id="sw-exp" onclick="setType('exp')">Gasto</div>
                <div class="st-opt" id="sw-inc" onclick="setType('inc')">Ingreso</div>
            </div>
            <input type="hidden" id="fType" value="exp">
            
            <div class="form-grid">
                <div class="inp-control">
                    <label class="inp-label">Monto</label>
                    <input type="number" id="fAmount" class="inp-field" placeholder="0.00" step="0.01" required>
                </div>
                <div class="inp-control">
                    <label class="inp-label">Fecha</label>
                    <input type="date" id="fDate" class="inp-field" required>
                </div>
            </div>

            <div class="inp-control">
                <label class="inp-label">Categoría</label>
                <select id="fCat" class="inp-field" onchange="renderConcepts()" required></select>
            </div>

            <div class="inp-control">
                <label class="inp-label">Concepto</label>
                <select id="fConcept" class="inp-field" onchange="checkNewConcept()" required></select>
                <input type="text" id="fConceptCustom" class="inp-field" style="margin-top:10px; display:none;" placeholder="Escribe el nombre...">
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <input type="checkbox" id="fExec" checked>
                <label for="fExec" style="font-size:13px; font-weight:600;">Consolidado (Ya ocurrió)</label>
            </div>

            <button type="submit" id="btnSave" class="btn-full">GUARDAR OPERACIÓN</button>
            <button type="button" id="btnDel" onclick="del(editId)" class="btn-danger-text" style="display:none;">Eliminar este movimiento</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: { "Esenciales": ["Alquiler", "Luz/Gas", "Supermercado"], "Deudas": ["Tarjeta Visa"], "Sueldo": ["Javier", "Mary"] } };
    let data = defData;
    let editId = null, chartInstance = null, currentTxs = [], currentChartFilter = null;

    window.onload = () => {
        const d = new Date();
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        document.getElementById('dateInput').value = d.toISOString().slice(0, 7);
        if(localStorage.getItem('usdRate')) document.getElementById('usdRate').value = localStorage.getItem('usdRate');
        forceSync();
    };

    async function forceSync() {
        setStatus("Sincronizando...", false);
        try {
            const res = await fetch(API_URL);
            const cloudData = await res.json();
            if(cloudData && cloudData.txs) { data = cloudData; loadData(); setStatus("En Línea", true); }
        } catch(e) { setStatus("Offline", false); }
    }

    async function saveData() {
        setStatus("Guardando...", false);
        try {
            localStorage.setItem('usdRate', document.getElementById('usdRate').value);
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
            setStatus("En Línea", true); loadData();
        } catch(e) { setStatus("Error", false); }
    }

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('monthTxt').innerText = `${months[parseInt(m)-1]} ${y}`;
        
        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => a.date.localeCompare(b.date));
        renderTables(currentTxs);
        resetChart();
        renderCats();
    }

    function renderTables(txs) {
        const tInc = document.getElementById('table-inc'), tExp = document.getElementById('table-exp');
        tInc.innerHTML = ''; tExp.innerHTML = '';
        let sumInc=0, sumExp=0; const today = new Date().toISOString().split('T')[0];

        txs.forEach(t => {
            const isInc = t.type === 'inc';
            const amt = Math.abs(t.amount);
            if(isInc) sumInc += amt; else sumExp += amt;

            let dot = '';
            if(!t.exec && !isInc && (new Date(t.date) - new Date(today)) / 86400000 <= 5) dot = `<div style="display:inline-block; width:6px; height:6px; background:#F59E0B; border-radius:50%; margin-left:5px;" title="Vence pronto"></div>`;

            const tr = document.createElement('tr');
            tr.onclick = () => edit(t.id);
            tr.innerHTML = `
                <td>${t.date.split('-')[2]}</td>
                <td><span class="cat-badge">${t.cat}</span></td>
                <td style="font-weight:600;">${t.desc} ${dot}</td>
                <td class="amt-cell ${isInc?'positive':'negative'}" style="text-align:right;">${isInc?'+':''}$${Math.floor(amt).toLocaleString()}</td>
            `;
            (isInc ? tInc : tExp).appendChild(tr);
        });

        document.getElementById('sum-inc').innerText = `$${sumInc.toLocaleString()}`;
        document.getElementById('sum-exp').innerText = `$${sumExp.toLocaleString()}`;
        
        const bal = sumInc - sumExp;
        const balEl = document.getElementById('kpiBal');
        balEl.innerText = `$${bal.toLocaleString()}`;
        balEl.style.color = bal >= 0 ? 'var(--success)' : 'var(--danger)';

        const rate = parseFloat(document.getElementById('usdRate').value) || 1;
        document.getElementById('kpiUsd').innerText = (bal/rate).toFixed(2);
        
        // Tasa de ahorro
        let rateSav = 0;
        if (sumInc > 0) rateSav = ((sumInc - sumExp) / sumInc) * 100;
        document.getElementById('savingRate').innerText = rateSav.toFixed(0) + "%";
        document.getElementById('savingRate').style.color = rateSav > 0 ? 'var(--success)' : 'var(--text-secondary)';
    }

    function renderChart(txs, filterCat) {
        const ctx = document.getElementById('myChart'); 
        if(chartInstance) chartInstance.destroy();
        
        currentChartFilter = filterCat;
        const btnReset = document.getElementById('chartReset');
        const centerTxt = document.getElementById('chartCenterText');
        
        // Use global currentTxs if txs not passed correctly or recursive
        const sourceTxs = txs || currentTxs;

        let exps = sourceTxs.filter(t => t.type === 'exp');
        let map = {};

        if (!filterCat) {
            btnReset.style.display = 'none';
            centerTxt.innerHTML = "Toca para<br>detalle";
            map = exps.reduce((a,t)=>{ a[t.cat]=(a[t.cat]||0)+t.amount; return a; }, {});
        } else {
            btnReset.style.display = 'block';
            centerTxt.innerText = filterCat;
            map = exps.filter(t => t.cat === filterCat).reduce((a,t)=>{ a[t.desc]=(a[t.desc]||0)+t.amount; return a; }, {});
        }

        const labels = Object.keys(map);
        const values = Object.values(map);

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: values, 
                    backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1'],
                    borderWidth: 0
                }] 
            },
            options: { 
                responsive:true, maintainAspectRatio:false, cutout:'70%',
                plugins: { legend: { display: false } },
                onClick: (e, elements) => {
                    if (elements.length > 0 && !filterCat) {
                        renderChart(sourceTxs, labels[elements[0].index]);
                    }
                }
            }
        });
    }

    function resetChart() { renderChart(currentTxs, null); }

    // --- FORM LOGIC ---
    function openSheet() { if(!editId) resetForm(); document.getElementById('modal').classList.add('open'); document.getElementById('overlay').style.display='block'; }
    function closeSheet() { document.getElementById('modal').classList.remove('open'); document.getElementById('overlay').style.display='none'; setTimeout(resetForm,300); }
    
    function setType(t) {
        document.getElementById('fType').value = t;
        document.getElementById('sw-inc').className = `st-opt ${t=='inc'?'active inc':''}`;
        document.getElementById('sw-exp').className = `st-opt ${t=='exp'?'active exp':''}`;
        renderCats();
    }
    
    function renderCats() {
        const t = document.getElementById('fType').value;
        const s = document.getElementById('fCat'); s.innerHTML='';
        (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear...','new'));
        renderConcepts();
    }
    
    function renderConcepts() {
        const cVal = document.getElementById('fCat').value;
        if(cVal==='new'){ 
            const n=prompt('Nombre Categoría:'); 
            if(n){ data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; saveData(); renderCats(); document.getElementById('fCat').value=n; } 
            else { renderCats(); return; }
        }
        const s = document.getElementById('fConcept'); s.innerHTML='';
        (data.concepts[cVal]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Nuevo...','new_c'));
        checkNewConcept();
    }
    
    function checkNewConcept() {
        const isNew = document.getElementById('fConcept').value==='new_c';
        document.getElementById('fConceptCustom').style.display=isNew?'block':'none';
    }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value;
        let desc = document.getElementById('fConcept').value;
        if(desc==='new_c') {
            desc=document.getElementById('fConceptCustom').value;
            if(!desc) return;
            if(!data.concepts[cat]) data.concepts[cat]=[];
            data.concepts[cat].push(desc);
        }
        const tx = { id:editId||Date.now(), date:document.getElementById('fDate').value, amount:parseFloat(document.getElementById('fAmount').value), type:document.getElementById('fType').value, cat, desc, exec:document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i!==-1) data.txs[i]=tx; } else { if(!data.txs) data.txs=[]; data.txs.push(tx); }
        saveData(); closeSheet();
    }

    function edit(id) {
        const t = data.txs.find(x=>x.id==id); if(!t)return;
        editId=id; document.getElementById('formTitle').innerText='Editar';
        document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=Math.abs(t.amount);
        document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts();
        const s=document.getElementById('fConcept');
        let has=false; for(let i=0;i<s.options.length;i++) if(s.options[i].value==t.desc) has=true;
        if(!has) s.add(new Option(t.desc,t.desc),0); s.value=t.desc;
        checkNewConcept(); document.getElementById('btnDel').style.display='block'; document.getElementById('btnSave').innerText='GUARDAR CAMBIOS';
        openSheet();
    }

    function resetForm() { 
        editId=null; document.getElementById('txForm').reset(); 
        document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; 
        document.getElementById('formTitle').innerText='Nuevo Movimiento'; 
        document.getElementById('btnDel').style.display='none'; 
        document.getElementById('fConceptCustom').style.display='none'; 
        document.getElementById('btnSave').innerText='GUARDAR OPERACIÓN'; 
        setType('exp'); 
    }
    
    function del(id) { if(confirm('¿Borrar movimiento?')) { data.txs=data.txs.filter(x=>x.id!=id); saveData(); closeSheet(); } }
    
    function navMonth(n) { const i = document.getElementById('dateInput'); let [y,m]=i.value.split('-'); i.value = new Date(parseInt(y), parseInt(m)-1+n, 1).toISOString().slice(0,7); loadData(); }
    
    function clearMonth() {
        const ym = document.getElementById('dateInput').value;
        if(!confirm(`⚠️ ¿Limpiar TODO el mes de ${ym}?`)) return;
        data.txs = data.txs.filter(t => !t.date.startsWith(ym)); saveData();
    }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`JM_Cloud_Backup.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ try{data=JSON.parse(e.target.result); saveData();}catch(x){alert('Error');} }; r.readAsText(i.files[0]); }
    function setStatus(t, ok) { document.getElementById('syncStatusText').innerText = t; document.getElementById('statusDot').className = ok ? 'dot online' : 'dot'; }
</script>
</body>
</html>
