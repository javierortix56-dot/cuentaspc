<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&M Finance Pro V25.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-app: #F1F5F9; --surface: #FFFFFF; --border: #E2E8F0;
            --text-main: #0F172A; --text-muted: #64748B;
            --primary: #2563EB; --primary-hover: #1D4ED8;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
            --radius: 10px;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; height: 100vh; overflow: hidden; font-size: 13px; }

        /* LAYOUT */
        .app-grid { display: grid; grid-template-columns: 240px 1fr 320px; height: 100vh; width: 100vw; }
        
        /* SIDEBAR */
        .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; gap: 20px; }
        .brand { font-size: 18px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .stat-card { background: var(--bg-app); padding: 12px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 10px; }
        .stat-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .stat-val { font-size: 18px; font-weight: 700; margin-top: 4px; }
        .btn-tool { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; width: 100%; text-align: left; margin-top: 5px; }
        .btn-tool:hover { background: var(--bg-app); color: var(--text-main); }

        /* MAIN */
        .main-content { display: flex; flex-direction: column; overflow: hidden; background: var(--bg-app); }
        .top-bar { background: var(--surface); padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .month-ctrl { display: flex; align-items: center; gap: 10px; background: var(--bg-app); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .btn-month { border: none; background: transparent; cursor: pointer; padding: 5px 10px; }
        .table-container { flex: 1; overflow-y: auto; padding: 20px; }
        .tx-table { width: 100%; border-collapse: collapse; }
        .tx-table th { text-align: left; color: var(--text-muted); font-size: 11px; text-transform: uppercase; padding: 10px; position: sticky; top: 0; background: var(--bg-app); border-bottom: 2px solid var(--border); }
        .tx-table td { padding: 12px 10px; border-bottom: 1px solid var(--border); background: var(--surface); }
        .tx-table tr:hover td { background: #F8FAFC; cursor: pointer; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: #F1F5F9; color: var(--text-muted); }
        .amt-inc { color: var(--success); font-weight: 700; } .amt-exp { color: var(--text-main); font-weight: 600; }

        /* INSPECTOR */
        .inspector { background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
        .inspector-section { padding: 20px; border-bottom: 1px solid var(--border); }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 10px; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        input, select { width: 100%; height: 38px; padding: 0 10px; border: 1px solid var(--border); border-radius: 6px; background: #F8FAFC; }
        .btn-primary { width: 100%; height: 40px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .toggle-group { display: flex; background: #F1F5F9; padding: 3px; border-radius: 6px; margin-bottom: 15px; }
        .toggle-opt { flex: 1; border: none; background: transparent; padding: 6px; font-size: 11px; font-weight: 700; color: var(--text-muted); cursor: pointer; border-radius: 4px; }
        .toggle-opt.active { background: white; color: var(--text-main); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="app-grid">
    <aside class="sidebar">
        <div class="brand"><i class="fas fa-wallet"></i> J&M Pro V25.1</div>
        
        <div class="stat-card">
            <div class="stat-label">Balance Mes</div>
            <div class="stat-val" id="kpiBal">$0</div>
            <div class="stat-label" style="margin-top:5px; color:var(--primary)" id="kpiUsd">US$ 0.00</div>
        </div>
        <div class="stat-card" style="border-left:3px solid var(--success)">
            <div class="stat-label">Ingresos</div>
            <div class="stat-val" style="color:var(--success)" id="kpiInc">$0</div>
        </div>
        <div class="stat-card" style="border-left:3px solid var(--danger)">
            <div class="stat-label">Egresos</div>
            <div class="stat-val" style="color:var(--danger)" id="kpiExp">$0</div>
        </div>

        <div style="margin-top:auto">
            <label>Dólar Ref.</label>
            <input type="number" id="usdRate" value="1200" onchange="loadData()">
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            <button class="btn-tool" onclick="backup()"><i class="fas fa-download"></i> Guardar Backup</button>
            <button class="btn-tool" onclick="document.getElementById('fileIn').click()"><i class="fas fa-upload"></i> Restaurar Backup</button>
            <input type="file" id="fileIn" hidden onchange="restoreSmart(this)">
        </div>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <div class="month-ctrl">
                <button class="btn-month" onclick="addMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div style="font-weight:700; min-width:120px; text-align:center; position:relative;">
                    <span id="monthTxt">...</span>
                    <input type="month" id="dateInput" onchange="loadData()" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                </div>
                <button class="btn-month" onclick="addMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </header>
        <div class="table-container">
            <table class="tx-table">
                <thead><tr><th width="50">Día</th><th>Descripción</th><th>Categoría</th><th style="text-align:right">Monto</th></tr></thead>
                <tbody id="txTableBody"></tbody>
            </table>
        </div>
    </main>

    <aside class="inspector">
        <div class="inspector-section" style="height:250px; position:relative;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:800; font-size:12px;">Gráfico</span>
                <button id="chartBackBtn" onclick="renderChart(currentTxs)" style="border:none; background:none; color:var(--primary); font-size:10px; cursor:pointer; display:none;">Volver</button>
            </div>
            <div style="height:200px;"><canvas id="myChart"></canvas></div>
        </div>
        
        <div class="inspector-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span style="font-weight:800;" id="formTitle">Nuevo</span>
                <button onclick="resetForm()" style="border:none; background:none;"><i class="fas fa-plus"></i></button>
            </div>
            <form id="txForm">
                <div class="toggle-group">
                    <button type="button" class="toggle-opt active" id="typeExp" onclick="setType('exp')">Gasto</button>
                    <button type="button" class="toggle-opt" id="typeInc" onclick="setType('inc')">Ingreso</button>
                </div>
                <input type="hidden" id="fType" value="exp">
                <div class="form-group"><label>Fecha</label><input type="date" id="fDate" required></div>
                <div class="form-group"><label>Monto</label><input type="number" id="fAmount" step="0.01" required></div>
                <div class="form-group"><label>Categoría</label><select id="fCat" onchange="renderConcepts()" required></select></div>
                <div class="form-group"><label>Concepto</label><select id="fConcept" onchange="checkNewConcept()" required></select><input type="text" id="fConceptCustom" style="display:none; margin-top:5px;" placeholder="Nuevo..."></div>
                <div class="form-group" style="display:flex; gap:10px; align-items:center;">
                    <input type="checkbox" id="fExec" checked style="width:16px; height:16px;"><label style="margin:0">Pagado</label>
                </div>
                <button type="submit" id="btnSave" class="btn-primary">GUARDAR</button>
                <button type="button" id="btnDel" onclick="del(editId)" style="width:100%; margin-top:10px; background:var(--danger); color:white; border:none; padding:10px; border-radius:6px; display:none;">Eliminar</button>
            </form>
        </div>
    </aside>
</div>

<script>
    // Configuración Inicial
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal'], inc:['Ingresos Generales'] }, concepts: { "Esenciales": ["Alquiler"], "Ingresos Generales": ["Sueldo"] } };
    let data = JSON.parse(localStorage.getItem('finData_v25')) || defData;
    let editId = null, chartInstance = null, currentTxs = [];

    window.onload = () => {
        document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('dateInput').value = new Date().toISOString().slice(0, 7);
        loadData();
    };

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        document.getElementById('monthTxt').innerText = new Date(y, m-1).toLocaleString('es-ES', { month:'long', year:'numeric' }).toUpperCase();
        
        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym)).sort((a,b) => b.date.localeCompare(a.date));
        renderTable(currentTxs); calcKPIs(currentTxs); renderChart(currentTxs); renderCats();
    }

    function renderTable(txs) {
        const tbody = document.getElementById('txTableBody'); tbody.innerHTML = '';
        txs.forEach(t => {
            const tr = document.createElement('tr'); tr.onclick = () => edit(t.id);
            const isInc = t.type === 'inc';
            tr.innerHTML = `<td>${t.date.split('-')[2]}</td>
                <td><div style="font-weight:600">${t.desc}</div><div style="font-size:10px; color:#94A3B8">${t.exec?'Pagado':'Pendiente'}</div></td>
                <td><span class="badge">${t.cat}</span></td>
                <td style="text-align:right" class="${isInc?'amt-inc':'amt-exp'}">${isInc?'+':''}$${Math.abs(t.amount).toLocaleString()}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Lógica del Formulario
    function setType(t) { document.getElementById('fType').value=t; document.getElementById('typeExp').className=`toggle-opt ${t=='exp'?'active':''}`; document.getElementById('typeInc').className=`toggle-opt ${t=='inc'?'active':''}`; renderCats(); }
    function renderCats() { const t=document.getElementById('fType').value; const s=document.getElementById('fCat'); s.innerHTML=''; (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear','new')); renderConcepts(); }
    function renderConcepts() { const c=document.getElementById('fCat').value; if(c==='new'){ addCat(); return; } const s=document.getElementById('fConcept'); s.innerHTML=''; (data.concepts[c]||[]).forEach(x=>s.add(new Option(x,x))); s.add(new Option('+ Crear','new')); checkNewConcept(); }
    function checkNewConcept() { const v=document.getElementById('fConcept').value; document.getElementById('fConceptCustom').style.display = v==='new'?'block':'none'; }
    function addCat() { const n=prompt('Nombre Categoría:'); if(n) { data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; save(); renderCats(); document.getElementById('fCat').value=n; renderConcepts(); } else renderCats(); }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value, desc = document.getElementById('fConcept').value;
        if(desc==='new') { desc=document.getElementById('fConceptCustom').value; if(!data.concepts[cat].includes(desc)) data.concepts[cat].push(desc); }
        const tx = { id: editId || Date.now(), date: document.getElementById('fDate').value, amount: parseFloat(document.getElementById('fAmount').value), type: document.getElementById('fType').value, cat, desc, exec: document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i>=0) data.txs[i]=tx; } else data.txs.push(tx);
        save(); resetForm(); loadData();
    };

    function edit(id) {
        const t = data.txs.find(x=>x.id==id); if(!t) return;
        editId=id; document.getElementById('formTitle').innerText='Editar';
        document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=t.amount; document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts();
        if(!document.getElementById('fConcept').querySelector(`option[value="${t.desc}"]`)) document.getElementById('fConcept').add(new Option(t.desc,t.desc));
        document.getElementById('fConcept').value=t.desc; document.getElementById('btnSave').innerText='ACTUALIZAR'; document.getElementById('btnDel').style.display='block';
    }
    
    function resetForm() { editId=null; document.getElementById('formTitle').innerText='Nuevo'; document.getElementById('txForm').reset(); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('btnSave').innerText='GUARDAR'; document.getElementById('btnDel').style.display='none'; setType('exp'); }
    function del(id) { if(confirm('¿Eliminar?')) { data.txs=data.txs.filter(x=>x.id!=id); save(); resetForm(); loadData(); } }
    function save() { localStorage.setItem('finData_v25', JSON.stringify(data)); }
    function addMonth(n) { const i=document.getElementById('dateInput'); let [y,m]=i.value.split('-'); const d=new Date(y,m-1+n,1); i.value=d.toISOString().slice(0,7); loadData(); }

    // KPI & Chart
    function calcKPIs(txs) {
        let i=0, e=0; txs.forEach(t=>{ if(t.type=='inc') i+=t.amount; else e+=t.amount; });
        document.getElementById('kpiInc').innerText=`$${i.toLocaleString()}`; document.getElementById('kpiExp').innerText=`$${e.toLocaleString()}`;
        document.getElementById('kpiBal').innerText=`$${(i-e).toLocaleString()}`; document.getElementById('kpiUsd').innerText=`US$ ${((i-e)/1200).toFixed(2)}`;
    }
    function renderChart(txs, catFilter=null) {
        const ctx = document.getElementById('myChart'); if(chartInstance) chartInstance.destroy();
        const exps = txs.filter(t=>t.type=='exp');
        const map = exps.reduce((acc,t) => {
            const key = catFilter ? t.desc : t.cat;
            if(!catFilter || t.cat === catFilter) acc[key] = (acc[key]||0) + t.amount;
            return acc;
        }, {});
        document.getElementById('chartBackBtn').style.display = catFilter ? 'block' : 'none';
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6'], borderWidth:0 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, onClick:(e,i)=>{ if(i.length && !catFilter) renderChart(txs, Object.keys(map)[i[0].index]); } }
        });
    }

    // --- RESTAURACIÓN INTELIGENTE ---
    function restoreSmart(input) {
        const fr = new FileReader();
        fr.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                
                // DETECTOR DE FORMATO DEL ARCHIVO "finanzas_full_backup.json"
                if (json.appData && json.transactions) {
                    alert("Formato detectado: Convirtiendo datos...");
                    
                    // 1. Mapear Categorías
                    const newCats = {
                        inc: json.appData.categories.income || [],
                        exp: json.appData.categories.expense || []
                    };
                    
                    // 2. Mapear Conceptos
                    const newConcepts = json.appData.concepts || {};
                    
                    // 3. Traducir Transacciones
                    const newTxs = json.transactions.map(t => {
                        const isIncome = t.amount >= 0; 
                        // Regla especial: Si la categoría dice "Ingreso...", forzar tipo 'inc'
                        const derivedType = (isIncome || t.category.toLowerCase().includes('ingreso')) ? 'inc' : 'exp';
                        
                        return {
                            id: t.id,
                            date: t.date,
                            amount: Math.abs(t.amount), // Convertir a positivo absoluto
                            type: derivedType,
                            cat: t.category,
                            desc: t.text, // Mapear 'text' a 'desc'
                            exec: t.executed !== false // Si no existe executed, asumir true
                        };
                    });

                    data = { txs: newTxs, cats: newCats, concepts: newConcepts };
                    save();
                    alert("¡Restauración exitosa!");
                    location.reload();
                    return;
                }

                // FORMATO ESTÁNDAR
                if(json.txs) {
                    data = json;
                    save();
                    alert("Backup restaurado.");
                    location.reload();
                } else {
                    alert("Formato desconocido.");
                }
            } catch(err) { alert("Error al leer archivo: " + err.message); }
        };
        fr.readAsText(input.files[0]);
        input.value='';
    }
</script>
</body>
</html>
