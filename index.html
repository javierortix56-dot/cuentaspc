<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J&M Financial V40.5 (Final Fix)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --sidebar-bg: #111827; 
            --sidebar-text: #9CA3AF;
            --sidebar-active: #3B82F6;
            --main-bg: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-secondary: #6B7280;
            --success: #10B981;
            --danger: #EF4444;
            --info: #2563EB;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--main-bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 230px;
            background: var(--sidebar-bg);
            display: flex; flex-direction: column; flex-shrink: 0;
            border-right: 1px solid #1F2937;
        }
        .logo-box {
            height: 60px; display: flex; align-items: center; padding: 0 20px;
            font-size: 18px; font-weight: 800; color: white; letter-spacing: -0.5px;
            background: rgba(255,255,255,0.03);
        }
        .logo-box span { color: var(--info); margin-left: 5px; }

        .nav-menu { padding: 20px 10px; flex: 1; }
        .nav-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 12px;
            color: var(--sidebar-text); border-radius: 6px; cursor: pointer;
            transition: 0.2s; margin-bottom: 2px; font-size: 13px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--sidebar-active); color: white; }
        .nav-item i { width: 16px; text-align: center; }

        .sidebar-footer { padding: 15px; border-top: 1px solid #1F2937; }
        .status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 4px 10px; border-radius: 20px; background: rgba(255,255,255,0.05);
            font-size: 10px; color: #9CA3AF; font-weight: 600;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #4B5563; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }

        /* --- MAIN AREA --- */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .top-header {
            height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0;
        }
        .page-header h1 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text-main); }
        .page-header p { margin: 0; font-size: 11px; color: var(--text-secondary); }

        .header-controls { display: flex; align-items: center; gap: 10px; }
        .date-selector {
            display: flex; align-items: center; background: #F9FAFB; 
            border: 1px solid var(--border); border-radius: 6px; padding: 2px;
        }
        .btn-nav {
            border: none; background: transparent; width: 24px; height: 24px; 
            border-radius: 4px; cursor: pointer; color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }
        .btn-nav:hover { background: #E5E7EB; color: var(--text-main); }
        .current-month {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            padding: 0 10px; min-width: 110px; text-align: center; position: relative;
        }
        .btn-action {
            background: var(--text-main); color: white; border: none; padding: 0 15px; height: 32px; 
            border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; 
            cursor: pointer; box-shadow: var(--shadow-sm); transition: 0.2s;
        }
        .btn-action:hover { background: #000; transform: translateY(-1px); }

        /* CONTENT */
        .content-area { flex: 1; overflow-y: auto; padding: 20px 25px; }

        /* --- KPI ROW --- */
        .kpi-row {
            display: grid; 
            grid-template-columns: 20% 20% 1fr; 
            gap: 15px; 
            margin-bottom: 20px;
        }
        .kpi-card {
            background: var(--card-bg); border-radius: 10px; padding: 15px; 
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; justify-content: center;
            height: 90px;
            min-width: 0; 
        }
        .kpi-label { 
            font-size: 10px; font-weight: 700; text-transform: uppercase; 
            color: var(--text-secondary); margin-bottom: 5px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .kpi-value { 
            font-size: 22px; font-weight: 800; color: var(--text-main); line-height: 1; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(to right, #EFF6FF, #FFFFFF);
            border: 1px solid #BFDBFE;
            flex-direction: row; 
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }
        
        .bal-section-left { display: flex; flex-direction: column; justify-content: center; min-width: 120px; }
        .bal-pesos { font-size: 28px; font-weight: 900; color: #1E3A8A; letter-spacing: -0.5px; white-space: nowrap; }
        
        .bal-section-center { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            flex: 1; border-left: 1px dashed #BFDBFE; border-right: 1px dashed #BFDBFE; margin: 0 15px;
            overflow: hidden; 
        }
        .usd-main { font-size: 18px; font-weight: 800; color: #334155; white-space: nowrap; }
        .tc-input-group { display: flex; align-items: center; gap: 5px; margin-top: 4px; background: white; padding: 2px 8px; border-radius: 15px; border: 1px solid #CBD5E1; }
        .tc-label { font-size: 10px; font-weight: 700; color: #64748B; }
        
        /* FIX: Quitar arrows del input number y ampliar width */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .rate-edit { border: none; width: 55px; font-size: 12px; font-weight: 700; color: #334155; text-align: right; outline:none; background: transparent; }

        .bal-section-right { text-align: right; min-width: 80px; }
        .bal-badge { 
            background: #DCFCE7; color: #166534; padding: 5px 10px; border-radius: 8px; 
            font-size: 12px; font-weight: 700; border: 1px solid #86EFAC; display: inline-block; white-space: nowrap;
        }

        /* --- FILTROS BAR + BÚSQUEDA --- */
        .filter-bar {
            display: flex; gap: 10px; margin-bottom: 15px; align-items: center;
            background: white; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);
            flex-wrap: wrap; 
        }
        .filter-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); margin-right: 5px; text-transform: uppercase; }
        .filter-input {
            border: 1px solid var(--border); border-radius: 6px; padding: 5px 8px; font-size: 12px; font-family: 'Inter'; color: var(--text-main); background: #F9FAFB;
        }
        .filter-input:focus { border-color: var(--info); background: white; }
        
        #filterSearch { flex: 1; min-width: 150px; }
        
        .btn-reset-filter {
            margin-left: auto; border: none; background: #F3F4F6; color: var(--text-secondary);
            font-size: 11px; font-weight: 600; padding: 5px 10px; border-radius: 4px; cursor: pointer;
        }
        .btn-reset-filter:hover { background: #E5E7EB; color: var(--text-main); }


        /* COPY ZONE */
        .copy-zone {
            display: none; background: white; border: 1px dashed var(--border); border-radius: 10px; padding: 10px; margin-bottom: 15px; text-align: center;
        }
        .copy-controls { display: flex; justify-content: center; gap: 10px; margin-top: 5px; align-items: center; }
        .btn-copy-month { background: var(--text-main); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 11px; cursor: pointer; }

        /* LAYOUT PRINCIPAL */
        .layout-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: start; }

        /* --- CUENTAS T --- */
        .t-account-container {
            background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);
            box-shadow: var(--shadow-sm); overflow: hidden; display: flex; flex-direction: column;
            height: calc(100vh - 320px);
            min-height: 400px;
        }
        .t-header {
            background: #F8FAFC; padding: 10px 15px; border-bottom: 1px solid var(--border);
            text-align: center; font-size: 12px; font-weight: 800; color: var(--text-main); letter-spacing: 0.5px; text-transform: uppercase;
            flex-shrink: 0;
        }
        .t-body { display: flex; flex: 1; position: relative; overflow: hidden; }
        
        .t-divider { width: 1px; background: var(--border); position: absolute; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 10; }
        .t-side { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .t-col-header {
            padding: 8px; text-align: center; font-size: 10px; font-weight: 700; text-transform: uppercase;
            border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .h-debe { color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .h-haber { color: var(--danger); background: rgba(239, 68, 68, 0.05); }

        .t-list-scroll { 
            flex: 1; overflow-y: auto; padding: 0; 
            scrollbar-width: thin; scrollbar-color: #E2E8F0 transparent;
        }
        .t-list-scroll::-webkit-scrollbar { width: 4px; }
        .t-list-scroll::-webkit-scrollbar-thumb { background-color: #E2E8F0; border-radius: 2px; }

        .t-row {
            padding: 8px 12px; border-bottom: 1px solid #F3F4F6; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; font-size: 12px; transition: 0.1s;
        }
        .t-row:hover { background: #F9FAFB; }
        .t-row.executed .t-desc { text-decoration: line-through; color: #9CA3AF; }
        .t-row.executed .t-amt { text-decoration: line-through; opacity: 0.6; }

        .t-desc { font-weight: 600; color: var(--text-main); }
        .t-meta { font-size: 9px; color: var(--text-secondary); margin-top: 1px; }
        .t-amt { font-weight: 700; text-align: right; }
        .t-green { color: var(--success); } .t-red { color: var(--danger); }

        .subtotal-tag {
            font-size: 8px; font-weight: 700; padding: 1px 4px; border-radius: 3px;
            display: block; margin-top: 2px; width: fit-content; margin-left: auto;
        }
        .st-ok { background: #DCFCE7; color: #166534; } 
        .st-bad { background: #FEE2E2; color: #991B1B; }

        /* --- CHART PANEL --- */
        .chart-card {
            background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border);
            box-shadow: var(--shadow-sm); padding: 15px; display: flex; flex-direction: column;
            height: calc(100vh - 320px); 
            min-height: 400px;
        }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .chart-title { font-size: 12px; font-weight: 700; }
        
        .chart-wrapper { height: 180px; position: relative; flex-shrink: 0; margin-bottom: 15px; }
        
        .legend-list { flex: 1; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; }
        .legend-item { 
            display: flex; align-items: center; justify-content: space-between; 
            font-size: 11px; padding: 6px 0; border-bottom: 1px dashed #F3F4F6; 
        }
        .leg-left { display: flex; align-items: center; gap: 8px; }
        .leg-color { width: 8px; height: 8px; border-radius: 2px; }
        .leg-cat { font-weight: 600; color: var(--text-main); font-size: 11px; }
        .leg-right { text-align: right; }
        .leg-pct { font-weight: 700; font-size: 10px; }
        .leg-amt { font-size: 9px; color: var(--text-secondary); }

        /* --- MODAL --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(2px); }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
            background: white; width: 380px; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .modal.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .modal-body { padding: 20px; }
        
        .type-toggle { display: flex; background: #F3F4F6; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
        .tt-opt { flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; color: var(--text-secondary); }
        .tt-opt.active.inc { background: var(--success); color: white; }
        .tt-opt.active.exp { background: var(--danger); color: white; }
        
        .inp-full { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 12px; background: #F9FAFB; font-size: 13px; }
        .btn-save { width: 100%; padding: 10px; background: var(--text-main); color: white; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; }
        
        .loader-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:200; display:none; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { width:30px; height:30px; border:3px solid #E5E7EB; border-top:3px solid var(--info); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
        .alert-dot { display: inline-block; width: 6px; height: 6px; background: #F59E0B; border-radius: 50%; margin-left: 5px; }
    </style>
</head>
<body>

<div id="loader" class="loader-overlay">
    <div class="spinner"></div>
    <div style="margin-top:10px; font-weight:600; color:#6B7280; font-size:12px;">Sincronizando...</div>
</div>

<aside class="sidebar">
    <div class="logo-box">J&M<span>Financial</span></div>
    <div class="nav-menu">
        <div class="nav-item active"><i class="fas fa-columns"></i> Dashboard</div>
        <div style="height:15px;"></div>
        <div class="nav-item" onclick="backup()"><i class="fas fa-download"></i> Backup Local</div>
        <div class="nav-item" onclick="document.getElementById('fileIn').click()"><i class="fas fa-file-import"></i> Restaurar <input type="file" id="fileIn" hidden onchange="restoreSmart(this)"></div>
        <div class="nav-item" onclick="forceSync()"><i class="fas fa-sync"></i> Sincronizar</div>
        <div class="nav-item" style="color:var(--danger);" onclick="clearMonth()"><i class="fas fa-trash-alt"></i> Limpiar Mes</div>
    </div>
    <div class="sidebar-footer">
        <div class="status-badge"><div id="statusDot" class="dot"></div><span id="syncStatusText">...</span></div>
    </div>
</aside>

<div class="main-wrapper">
    <header class="top-header">
        <div class="page-header">
            <h1>Resumen Financiero</h1>
            <p>Estado de cuenta</p>
        </div>
        <div class="header-controls">
            <div class="date-selector">
                <button class="btn-nav" onclick="navMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="current-month"><span id="monthTxt">...</span><input type="month" id="dateInput" onchange="loadData()" style="position:absolute; inset:0; opacity:0; cursor:pointer;"></div>
                <button class="btn-nav" onclick="navMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <button class="btn-action" onclick="openSheet()"><i class="fas fa-plus"></i> Nuevo</button>
        </div>
    </header>

    <div class="content-area">
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-label">Ingresos</div>
                <div class="kpi-value" style="color:var(--success);" id="sum-inc">$0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Gastos</div>
                <div class="kpi-value" style="color:var(--danger);" id="sum-exp">$0</div>
            </div>
            
            <div class="kpi-card balance-card">
                <div class="bal-section-left">
                    <div class="kpi-label" style="color:#3B82F6;">Balance Neto</div>
                    <div class="bal-pesos" id="kpiBal">$0</div>
                </div>
                
                <div class="bal-section-center">
                    <div class="usd-main">USD <span id="kpiUsd">0.00</span></div>
                    <div class="tc-input-group">
                        <span class="tc-label">TC:</span>
                        <input type="number" id="usdRate" value="1200" class="rate-edit" onchange="applyFilters()">
                    </div>
                </div>

                <div class="bal-section-right">
                    <div class="bal-badge" id="savingRate">0% Ahorro</div>
                </div>
            </div>
        </div>

        <div class="filter-bar">
            <i class="fas fa-search" style="color:var(--text-secondary);"></i>
            <input type="text" id="filterSearch" class="filter-input" placeholder="Buscar..." onkeyup="applyFilters()">

            <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>

            <span class="filter-label">Desde</span>
            <input type="date" id="filterStart" class="filter-input" onchange="applyFilters()">
            
            <span class="filter-label">Hasta</span>
            <input type="date" id="filterEnd" class="filter-input" onchange="applyFilters()">
            
            <select id="filterCat" class="filter-input" style="min-width:100px;" onchange="applyFilters()">
                <option value="all">Todas</option>
            </select>

            <button class="btn-reset-filter" onclick="resetFilters()">Limpiar</button>
        </div>

        <div class="copy-zone" id="copyZone">
            <div style="font-size:12px; color:var(--text-secondary); font-weight:600; margin-bottom:5px;">Mes vacío. Clonar:</div>
            <div class="copy-controls">
                <input type="month" id="copySourcePicker" class="inp-full" style="width:auto; height:32px; margin:0; padding:4px 8px;">
                <button class="btn-copy-month" onclick="copyFromSelected()"><i class="fas fa-copy"></i> CLONAR</button>
            </div>
        </div>

        <div class="layout-grid">
            <div class="t-account-container">
                <div class="t-header">Movimientos</div>
                <div class="t-body">
                    <div class="t-divider"></div>
                    <div class="t-side">
                        <div class="t-col-header h-debe">Entradas</div>
                        <div class="t-list-scroll" id="list-inc"></div>
                    </div>
                    <div class="t-side">
                        <div class="t-col-header h-haber">Salidas</div>
                        <div class="t-list-scroll" id="list-exp"></div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title">Distribución</span>
                    <button id="chartReset" onclick="resetChart()" style="border:none; background:none; color:var(--info); font-size:11px; cursor:pointer; display:none;">Ver todo</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="myChart"></canvas>
                    <div id="chartCenterText" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:9px; color:#64748B; pointer-events:none; font-weight:600; text-align:center;">Detalle</div>
                </div>
                <div class="legend-list" id="customLegend"></div>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="modal" id="modal">
    <div class="modal-head">
        <span id="formTitle">Movimiento</span>
        <i class="fas fa-times" style="cursor:pointer; color:#9CA3AF;" onclick="closeSheet()"></i>
    </div>
    <div class="modal-body">
        <form id="txForm">
            <div class="type-toggle">
                <div class="tt-opt" id="sw-exp" onclick="setType('exp')">Gasto</div>
                <div class="tt-opt" id="sw-inc" onclick="setType('inc')">Ingreso</div>
            </div>
            <input type="hidden" id="fType" value="exp">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="number" id="fAmount" class="inp-full" placeholder="Monto" step="0.01" required>
                <input type="date" id="fDate" class="inp-full" required>
            </div>
            <select id="fCat" class="inp-full" onchange="renderConcepts()" required></select>
            <select id="fConcept" class="inp-full" onchange="checkNewConcept()" required></select>
            <input type="text" id="fConceptCustom" class="inp-full" style="display:none;" placeholder="Nombre...">
            <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;"><input type="checkbox" id="fExec" checked> <label style="font-size:12px;">Consolidado</label></div>
            <button type="submit" id="btnSave" class="btn-save">GUARDAR</button>
            <button type="button" id="btnDel" onclick="del(editId)" style="width:100%; margin-top:10px; border:none; background:none; color:red; font-size:11px; font-weight:700; display:none; cursor:pointer;">Eliminar</button>
        </form>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    const defData = { txs: [], cats: { exp:['Esenciales','Deudas','Personal','Ahorro'], inc:['Sueldo','Ventas','Varios'] }, concepts: { "Esenciales": ["Alquiler", "Luz/Gas", "Supermercado"], "Deudas": ["Tarjeta Visa"], "Sueldo": ["Javier", "Mary"] } };
    const chartColors = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1','#64748B'];
    let data = defData;
    let editId = null, chartInstance = null, currentTxs = [], filteredTxs = [];

    window.onload = () => {
        const d = new Date();
        document.getElementById('fDate').value = d.toISOString().split('T')[0];
        document.getElementById('dateInput').value = d.toISOString().slice(0, 7);
        let prevM = new Date(); prevM.setMonth(prevM.getMonth()-1);
        document.getElementById('copySourcePicker').value = prevM.toISOString().slice(0, 7);
        if(localStorage.getItem('usdRate')) document.getElementById('usdRate').value = localStorage.getItem('usdRate');
        forceSync();
    };

    async function forceSync() {
        showLoad(true); setStatus("Conectando...", false);
        try {
            const res = await fetch(API_URL);
            const cloudData = await res.json();
            if(cloudData && cloudData.txs) { data = cloudData; loadData(); setStatus("En Línea", true); }
        } catch(e) { setStatus("Offline", false); }
        showLoad(false);
    }
    async function saveData() {
        setStatus("Guardando...", false);
        try {
            localStorage.setItem('usdRate', document.getElementById('usdRate').value);
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
            setStatus("En Línea", true); loadData();
        } catch(e) { setStatus("Error", false); }
    }

    function loadData() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        document.getElementById('monthTxt').innerText = `${months[parseInt(m)-1]} ${y}`;
        
        currentTxs = (data.txs || []).filter(t => t.date.startsWith(ym));
        currentTxs.sort((a,b) => {
            if (a.date !== b.date) return a.date.localeCompare(b.date);
            if (a.type !== b.type) return a.type === 'inc' ? -1 : 1; 
            if (a.exec !== b.exec) return b.exec - a.exec; 
            return Math.abs(b.amount) - Math.abs(a.amount); 
        });

        const uniqueCats = [...new Set(currentTxs.map(t => t.cat))].sort();
        const catSel = document.getElementById('filterCat');
        catSel.innerHTML = '<option value="all">Todas</option>';
        uniqueCats.forEach(c => catSel.add(new Option(c, c)));

        const lastDay = new Date(y, m, 0).getDate();
        document.getElementById('filterStart').value = `${ym}-01`;
        document.getElementById('filterEnd').value = `${ym}-${lastDay}`;
        document.getElementById('filterSearch').value = ''; 

        document.getElementById('copyZone').style.display = currentTxs.length === 0 ? 'block' : 'none';
        applyFilters();
    }

    function applyFilters() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        const cat = document.getElementById('filterCat').value;
        const term = document.getElementById('filterSearch').value.toLowerCase();

        filteredTxs = currentTxs.filter(t => {
            if(start && t.date < start) return false;
            if(end && t.date > end) return false;
            if(cat !== 'all' && t.cat !== cat) return false;
            if(term && !t.desc.toLowerCase().includes(term) && !t.cat.toLowerCase().includes(term)) return false; 
            return true;
        });

        renderTView(filteredTxs);
        renderChart(filteredTxs, null);
    }

    function resetFilters() {
        const ym = document.getElementById('dateInput').value;
        const [y, m] = ym.split('-');
        const lastDay = new Date(y, m, 0).getDate();
        document.getElementById('filterStart').value = `${ym}-01`;
        document.getElementById('filterEnd').value = `${ym}-${lastDay}`;
        document.getElementById('filterCat').value = 'all';
        document.getElementById('filterSearch').value = '';
        applyFilters();
    }

    function renderTView(txs) {
        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';
        let sInc=0, sExp=0, runningBalance=0; 
        const today = new Date().toISOString().split('T')[0];

        txs.forEach(t => {
            const isInc = t.type === 'inc'; 
            const amt = Math.abs(t.amount);
            
            if(isInc) { runningBalance += amt; sInc += amt; } 
            else { runningBalance -= amt; sExp += amt; }

            let dot = '';
            if(!t.exec && !isInc && (new Date(t.date) - new Date(today)) / 86400000 <= 5) dot = `<span class="alert-dot" title="Vence pronto"></span>`;
            
            let balHtml = '';
            if (!isInc) balHtml = `<span class="subtotal-tag ${runningBalance >= 0 ? 'st-ok' : 'st-bad'}">Quedan: $${Math.floor(runningBalance).toLocaleString()}</span>`;

            const div = document.createElement('div');
            div.className = `t-row ${t.exec ? 'executed' : ''}`; 
            div.onclick = () => edit(t.id);
            div.innerHTML = `
                <div style="flex:1">
                    <div class="t-desc">${t.desc} ${dot}</div>
                    <div class="t-meta">${t.cat} • ${t.date.split('-')[2]}</div>
                </div>
                <div style="text-align:right">
                    <div class="t-amt ${isInc?'t-green':'t-red'}">${isInc?'+':''}$${Math.floor(amt).toLocaleString()}</div>
                    ${balHtml}
                </div>`;
            (isInc ? lInc : lExp).appendChild(div);
        });

        document.getElementById('sum-inc').innerText = `$${sInc.toLocaleString()}`;
        document.getElementById('sum-exp').innerText = `$${sExp.toLocaleString()}`;
        
        const bal = sInc - sExp;
        document.getElementById('kpiBal').innerText = `$${bal.toLocaleString()}`;
        
        const rate = parseFloat(document.getElementById('usdRate').value) || 1;
        document.getElementById('kpiUsd').innerText = (bal/rate).toFixed(2);
        
        let savPct = 0; if(sInc > 0) savPct = ((sInc - sExp) / sInc) * 100;
        const savEl = document.getElementById('savingRate');
        savEl.innerText = `${savPct.toFixed(0)}% Ahorro`;
        savEl.style.background = savPct >= 0 ? '#DCFCE7' : '#FEE2E2';
        savEl.style.color = savPct >= 0 ? '#166534' : '#991B1B';
        savEl.style.borderColor = savPct >= 0 ? '#86EFAC' : '#FECACA';
    }

    function renderChart(txs, filterCat) {
        const ctx = document.getElementById('myChart'); if(chartInstance) chartInstance.destroy();
        const exps = txs.filter(t => t.type === 'exp');
        const totalExp = exps.reduce((a,t) => a + t.amount, 0);
        let map = {};

        if (!filterCat) {
            document.getElementById('chartReset').style.display = 'none';
            document.getElementById('chartCenterText').innerHTML = "Toca para<br>detalle";
            map = exps.reduce((a,t)=>{ a[t.cat]=(a[t.cat]||0)+t.amount; return a; }, {});
        } else {
            document.getElementById('chartReset').style.display = 'block';
            document.getElementById('chartCenterText').innerText = filterCat;
            map = exps.filter(t => t.cat === filterCat).reduce((a,t)=>{ a[t.desc]=(a[t.desc]||0)+t.amount; return a; }, {});
        }

        const sortedKeys = Object.keys(map).sort((a,b) => map[b] - map[a]);
        const values = sortedKeys.map(k => map[k]);

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: sortedKeys, datasets: [{ data: values, backgroundColor: chartColors, borderWidth: 0 }] },
            options: { 
                responsive:true, maintainAspectRatio:false, cutout:'70%',
                plugins: { legend: { display: false } },
                onClick: (e, el) => { if(el.length>0 && !filterCat) renderChart(txs, sortedKeys[el[0].index]); }
            }
        });

        const leg = document.getElementById('customLegend'); leg.innerHTML = '';
        sortedKeys.forEach((key, i) => {
            const val = map[key];
            const pct = totalExp > 0 ? ((val / totalExp) * 100).toFixed(1) + '%' : '0%';
            const color = chartColors[i % chartColors.length];
            const item = document.createElement('div'); item.className = 'legend-item';
            item.innerHTML = `<div class="leg-left"><div class="leg-color" style="background:${color}"></div><span class="leg-cat">${key}</span></div><div class="leg-right"><div class="leg-pct">${pct}</div><div class="leg-amt">$${Math.floor(val).toLocaleString()}</div></div>`;
            if(!filterCat) { item.style.cursor='pointer'; item.onclick = () => renderChart(txs, key); }
            leg.appendChild(item);
        });
    }

    function copyFromSelected() {
        const sourceYM = document.getElementById('copySourcePicker').value;
        const targetYM = document.getElementById('dateInput').value;
        if(!sourceYM || sourceYM === targetYM) return alert("Selecciona un mes origen distinto al actual");
        const sourceTxs = (data.txs || []).filter(t => t.date.startsWith(sourceYM));
        if(sourceTxs.length === 0) return alert("El mes origen no tiene datos");
        const newTxs = sourceTxs.map(t => {
            const day = t.date.split('-')[2];
            return { ...t, id: Date.now() + Math.random(), date: `${targetYM}-${day}`, exec: false };
        });
        data.txs = [...data.txs, ...newTxs]; saveData();
    }
    
    function resetChart() { renderChart(filteredTxs, null); }
    function openSheet() { if(!editId) resetForm(); document.getElementById('modal').classList.add('open'); document.getElementById('overlay').style.display='block'; }
    function closeSheet() { document.getElementById('modal').classList.remove('open'); document.getElementById('overlay').style.display='none'; }
    function setType(t) { document.getElementById('fType').value = t; document.getElementById('sw-inc').className = `tt-opt ${t=='inc'?'active inc':''}`; document.getElementById('sw-exp').className = `tt-opt ${t=='exp'?'active exp':''}`; renderCats(); }
    function renderCats() { const t = document.getElementById('fType').value, s = document.getElementById('fCat'); s.innerHTML=''; (data.cats[t]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Crear...','new')); renderConcepts(); }
    function renderConcepts() { const cVal = document.getElementById('fCat').value; if(cVal==='new'){ const n=prompt('Nueva Categoría:'); if(n){ data.cats[document.getElementById('fType').value].push(n); data.concepts[n]=[]; saveData(); renderCats(); document.getElementById('fCat').value=n; } else { renderCats(); return; } } const s = document.getElementById('fConcept'); s.innerHTML=''; (data.concepts[cVal]||[]).forEach(c=>s.add(new Option(c,c))); s.add(new Option('+ Nuevo...','new_c')); checkNewConcept(); }
    function checkNewConcept() { const isNew = document.getElementById('fConcept').value==='new_c'; document.getElementById('fConceptCustom').style.display=isNew?'block':'none'; }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value, desc = document.getElementById('fConcept').value;
        if(desc==='new_c') { desc=document.getElementById('fConceptCustom').value; if(!desc) return; if(!data.concepts[cat]) data.concepts[cat]=[]; data.concepts[cat].push(desc); }
        const tx = { id:editId||Date.now(), date:document.getElementById('fDate').value, amount:parseFloat(document.getElementById('fAmount').value), type:document.getElementById('fType').value, cat, desc, exec:document.getElementById('fExec').checked };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i!==-1) data.txs[i]=tx; } else { if(!data.txs) data.txs=[]; data.txs.push(tx); }
        saveData(); closeSheet();
    }
    function edit(id) {
        const t = data.txs.find(x=>x.id==id); if(!t)return;
        editId=id; document.getElementById('formTitle').innerText='Editar';
        document.getElementById('fDate').value=t.date; document.getElementById('fAmount').value=Math.abs(t.amount); document.getElementById('fExec').checked=t.exec;
        setType(t.type); document.getElementById('fCat').value=t.cat; renderConcepts(); document.getElementById('fConcept').value=t.desc;
        checkNewConcept(); document.getElementById('btnDel').style.display='block'; document.getElementById('btnSave').innerText='ACTUALIZAR';
        openSheet();
    }
    function resetForm() { editId=null; document.getElementById('txForm').reset(); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('formTitle').innerText='Nuevo'; document.getElementById('btnDel').style.display='none'; document.getElementById('fConceptCustom').style.display='none'; document.getElementById('btnSave').innerText='GUARDAR'; setType('exp'); }
    function del(id) { if(confirm('¿Eliminar?')) { data.txs=data.txs.filter(x=>x.id!=id); saveData(); closeSheet(); } }
    function navMonth(n) { const i = document.getElementById('dateInput'); let [y,m]=i.value.split('-'); i.value = new Date(parseInt(y), parseInt(m)-1+n, 1).toISOString().slice(0,7); loadData(); }
    function clearMonth() { const ym = document.getElementById('dateInput').value; if(!confirm(`⚠️ ¿Limpiar mes ${ym}?`)) return; data.txs = data.txs.filter(t => !t.date.startsWith(ym)); saveData(); }
    function backup() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); a.download=`JM_Backup.json`; a.click(); }
    function restoreSmart(i) { const r=new FileReader(); r.onload=e=>{ try{data=JSON.parse(e.target.result); saveData();}catch(x){alert('Error');} }; r.readAsText(i.files[0]); }
    function showLoad(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function setStatus(t, ok) { document.getElementById('syncStatusText').innerText = t; document.getElementById('statusDot').className = ok ? 'dot online' : 'dot'; }
</script>
</body>
</html>
